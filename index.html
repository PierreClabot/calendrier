<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">


    <script src="https://code.jquery.com/jquery-3.6.2.js" integrity="sha256-pkn2CUZmheSeyssYw3vMp1+xyub4m+e+QK4sQskvuo4=" crossorigin="anonymous"></script>

</head>
<body>
    <div id="periode-selecteur">

    </div>

    <div style="margin:4rem">
        <H1>J'écoute les évents...</H1>
        <div id="PERIODEECOUTEUR"></div>
   </div>

<script>



class Calendrier
{
    constructor(numero,date)
    {
        this.numero = numero;
        this.date = date ;
        this.n1 = -1;
        this.n2 = -1;
        this.selectionEnCours = false;
        this.dernierNo = -1; 
        this.calendrier = this.generateTab(numero,date);
        let tobjCal = this; 
        this.observers =[];
        //this.dernierNo = -1; !! NON dernierNo est mis à jour dans generateTAB!!



        $(window).mouseup(function(){
        })
    
        //@TODO -- FAIT
        // ecouter $("BOUTON MOIS SUIVANT").ON {
            // 
            // calcul nouvelle date
            // this.dateRecalcule(nouvelledate)
            //
            // notifier le conteneur
            // let evtPeriode={
            //      evtSrc : event,
            //      event : "dateAChangé",
            //      date : nouvelleDate            
            //  };
            // tobjCal.fire(evtPeriode);
        // }


        //@TODO -- FAIT ( BUG : Le clic est fait 2 fois )
        // ecouter $("BOUTON MOIS PRECEDENT").ON {
            // 
            // calcul nouvelle date
            // this.dateRecalcule(nouvelledate)
            //
            // notifier le conteneur
            // let evtPeriode={
            //      evtSrc : event,
            //      event : "dateAChangé",
            //      date : nouvelleDate
            //  };
            // tobjCal.fire(evtPeriode);
        // }

        $(document).on('click','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] .moisPrec',(event)=>{

            let jour = "1";
            let currentDate = new Date();
            let nouvelleDate2 = new Date(this.date.getFullYear(),this.date.getMonth()-1);

            if(((nouvelleDate2.getMonth()) == currentDate.getMonth())&&(nouvelleDate2.getFullYear() == currentDate.getFullYear()))
            {
                jour = currentDate.getDate();
            }

            let nouvelleDate = new Date(this.date.getFullYear(),this.date.getMonth()-1,jour);
            if(nouvelleDate.getTime()<currentDate.getTime())
            {
                nouvelleDate = currentDate;
            }

            console.log(nouvelleDate);
            this.date = nouvelleDate;
            this.dateRecalcule(nouvelleDate);
            let evtPeriode={
                    evtSrc : event,
                    event : "dateAChangé",
                    date : nouvelleDate,
                    mois : "precedent",
                    };
            this.fire(evtPeriode);

        }).on('click','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] .moisSuiv',(event)=>{
            let jour = "1";
            let currentDate = new Date();

            if(((this.date.getMonth()+1) == currentDate.getMonth())&&(this.date.getFullYear() == currentDate.getFullYear()))
            {
                jour = currentDate.getDate();
            }
            let nouvelleDate = new Date(this.date.getFullYear(),this.date.getMonth()+1,jour);
            this.date = nouvelleDate;
            this.dateRecalcule(nouvelleDate);
            
            let evtPeriode={
                    evtSrc : event,
                    event : "dateAChangé",
                    date : nouvelleDate,
                    mois : "suivant",
                    };
            
            this.fire(evtPeriode);
        });

        $("body").on('mousemove',document,function(){
            // if(!tobjCal.selectionEnCours)   { return;  }


        }).on('mouseup',window,function(event){
            let evtPeriode={
                 evtSrc : event,
                 event : "selectFin",
                 no    :  0
             };
            tobjCal.fire(evtPeriode);
        });

        $(document).on('mouseover','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td',function(evt){
            let evtPeriode={
                 evtSrc : evt,
                 event : "mouseHover",
                 no    :  parseInt(this.getAttribute("no"),10),
                 cal    :  parseInt(this.getAttribute("numCal"),10)
             };
            tobjCal.fire(evtPeriode);

        }).on('mouseup','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td',function(evt){
            let evtPeriode={
                 evtSrc : evt,
                 event : "mouseUp",
                 no    :  parseInt(this.getAttribute("no"),10)
             };
            tobjCal.fire(evtPeriode);


        
        }).on('mousedown','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td',function(evt){
             let evtPeriode={
                 evtSrc : evt,
                 event : "mouseDown",
                 no    :  parseInt(this.getAttribute("no"),10)
             };
             tobjCal.fire(evtPeriode);
        }).on('touchstart','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td',function(evt){
            
            let evtPeriode={
                 evtSrc : evt,
                 event : "mouseDown",
                 no    :  parseInt(this.getAttribute("no"),10)
             };
             tobjCal.fire(evtPeriode); 

        }).on('touchmove','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td',function(evt){

            let clientX = evt.touches[0].clientX;
            let clientY = evt.touches[0].clientY;
            let caseTouchMove = document.elementFromPoint(clientX, clientY);

            let evtPeriode={
                evtSrc : evt,
                event : "mouseHover",
                no    :  parseInt(caseTouchMove.getAttribute("no"),10),
                cal : parseInt(caseTouchMove.getAttribute("numCal"),10)
            };
            tobjCal.fire(evtPeriode); 

        }).on('touchend','div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td',function(evt){
            let evtPeriode={
                 evtSrc : evt,
                 event : "mouseUp",
                 no    :  parseInt(this.getAttribute("no"),10)
             };
            tobjCal.fire(evtPeriode);

        })

    }
    

    generateTab(numero,dateCal)
    {
        let cpt = 0;
        let tabMois = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"]
        this.date = dateCal ;
        let firstDay = this.getFirstDayMonth();
        let nbjours = this.getNbJours();
        let calendrierJours ="";

        let dateYear = dateCal.getFullYear();
        let dateMonth = dateCal.getMonth()+1;
        let dateDay = dateCal.getDate();

        let calendrierEntete = "<table data-calendrierNo="+numero+"><thead><tr><th class='col-1 moisPrec' ><i class='fa-solid fa-arrow-left'></i></th><th colspan='5'>"+tabMois[dateMonth-1]+" - "+dateCal.getFullYear()+"</th><th class='col-1 moisSuiv'><i class='fa-solid fa-arrow-right'></i></th></tr><tr><th>lu</th><th>ma</th><th>me</th><th>je</th><th>ve</th><th>sa</th><th>di</th></tr></thead>";
        let calendrierRows =calendrierEntete+"<tr>";

        let moisPrecedent = dateMonth -1;
        if(moisPrecedent<=0){
            moisPrecedent = 12;
        }
        let nbjoursmoisprecedent = nbjours[moisPrecedent-1];

        let jour = 0 ; 
        let jouravant = 0;
        for(let i=firstDay;i>0;i--)
        {
            jouravant++;
        }

        for(let i=0;i<jouravant;i++)
        {
            if((cpt%7 == 0) && (cpt !=0))
            {
                calendrierRows += calendrierJours+"</tr><tr>";
                calendrierJours ="";
            }

            calendrierJours = "<td class=\"day_before\" data-date=\""+dateYear+"/"+moisPrecedent+"/"+(nbjoursmoisprecedent-jour)+"\" no="+(jouravant-1-i)+" numCal="+this.numero+">"+(nbjoursmoisprecedent-jour)+"</td>" + calendrierJours;
            jour++;
            cpt++;
        }
        
        let calendrierJourMoisPrec = calendrierJours;
        let joursPasses = this.getJoursPasses(this.date);
        for(let i=joursPasses.length;i>0;i--){
            if((cpt%7 == 0) && (cpt !=0))
            {
                calendrierRows += calendrierJours+"</tr><tr>";
                calendrierJours ="";
            }
            
            calendrierJours += "<td class=\"day_before\" data-date=\""+dateYear+"/"+dateMonth+"/"+(dateDay-i)+"\" no="+cpt+" numCal="+this.numero+">"+(dateDay-i)+"</td>";
            cpt++;

        }   
        jour = 0;
        for(let i=joursPasses.length;i<nbjours[this.date.getMonth()];i++){
            
            if((cpt%7 == 0) && (cpt !=0))
            {
                calendrierRows += calendrierJours+"</tr><tr>";
                calendrierJours ="";
            }

            calendrierJours += "<td class=\"mois_courant\" data-date=\""+dateYear+"/"+dateMonth+"/"+(dateDay+jour)+"\" no="+cpt+" numCal="+this.numero+">"+(i+1)+"</td>";
            cpt++;
            jour++;


        }
        let jourafter = 1
        for(let i=cpt;i%7 != 0 ; i++)
        {   
            let moisSuivant = dateMonth + 1;
            let year = dateYear;
            if(moisSuivant>11){ 
                moisSuivant = 1;
                year = dateYear+1;
            }
            calendrierJours += "<td class=\"day_after\" data-name=\"day_after\" data-date=\""+year+"/"+moisSuivant+"/"+(jourafter)+"\" no="+cpt+" numCal="+this.numero+">"+(jourafter)+"</td>";
            this.dernierNo = cpt;
            cpt++;
            jourafter++
        }
        calendrierRows += calendrierJours+"</tr></table>";
        return calendrierRows;
    }
    
    getJoursPasses()
    {
        let tabJoursPasses =[];
        let currentDay = this.date.getDate();
        for(let i=1;i<currentDay;i++)
        {
            tabJoursPasses.push(i);
        }
        return tabJoursPasses;
    }

    getFirstDayMonth()
    {
        let date1 = new Date(this.date.getFullYear(),this.date.getMonth(),0);
        return date1.getDay();
    }

    getNbJours(){

        let tabnbjours=[];
        for(let i=-1;i<11;i++)
        {
            let month = (this.date.getMonth()+i)%12;

            let year = this.date.getFullYear()+Math.floor((this.date.getMonth()+i)/12);

            let nbjours = new Date(year,month+1,-1).getDate()+1;

            tabnbjours.splice(month,0,nbjours);

        }

        return tabnbjours;
        
    }

    selectionne(n1,n2){ 
        
        if(n1<0){ n1 = 0; }

        if(n2<0){
            n2 = this.dernierNo;
        }

        for(let i=n1;i<=n2;i++)
        {
            $('div[data-name="calendrier"][data-divcalendrierno="'+this.numero+'"] td').eq(i).toggleClass('cal-selection',true);
        }
    }


    // appelée par le conteneur
    dateRecalcule(nouvelleDate) {
        //@TODO -- FAIT 
        // recalcule les cases de ce calendrier
        
        // changer le libellé du mois / année dans l'entête
        // puis un truc du genre
        
        //  gérer changement année...        
        // newDomJours=this.generate  : note this.dernierNo est mis à jour dans this.generate
        // vider les cases DOM du div contenant les jours
        // append child(newDomJours) dans la bonne div ou tbody du table

        // envoyer un event au conteneur des 2 calendriers pour le tenir au courant...
        // ce dernier pourra par exemple supprimer la sélection courante des deux calendriers , etc...
        // let evtPeriode={
        //          evtSrc : event,
        //          event : "dateChange",  // <-- event à gérer dans le conteneur
        //          nouvelleDate  :  ....  // <-- on met la nouvelle date dans le event
        //  };
        // tobjCal.fire(evtPeriode);
        this.date = nouvelleDate;
        let newDomJours = this.generateTab(this.numero,nouvelleDate);
        $('div[data-divcalendrierno='+this.numero+']>table').remove();
        $('div[data-divcalendrierno='+this.numero+']').append(newDomJours);
        // this.addSpectacle("2022/12/20","2022/12/21","2022/12/27","2023/1/2","2023/1/12","2023/2/4");
        let evtPeriode={
                  evtSrc : event,
                  event : "dateChange",  // <-- event à gérer dans le conteneur
                  nouvelleDate  :  nouvelleDate  // <-- on met la nouvelle date dans le event
          };
        this.fire(evtPeriode);
    }

    
    casesJourAjour(date1,date2) {
        // @TODO -- FAIT MAIS PEUT ETRE A REVOIR
        // renvoie un objet { no1:xx , no2: yy }
        // xx = case no de date1 si dans période
        // yy = case no de date2 si dans période
        // noMin=-1
        // noMax=-1

        // pour chaque idate de ce calendrier
        //   si caseNode idate dans periode(date1,date2) et noMin=-1 alors noMin=caseNo
        //   si caseNode idate dans periode(date1,date2) alors noMax=caseNo
        // fin
        // renvoyer {n1:noMin,n2:noMax};
        
        //  { no1:-1 , no2: -1 }  // la période demandée n'est pas du tout dans ce calendrier
        
        //  { no1:15, no2: 24 }   // période demandée = case 15 à 24

        //  { no1:31 , no2: 34 }  // période demandée  sur 10 jours, mais seulement 4 jours correspondent dans ce calendrier
        // let monthD1 = date1.getMonth();
        // let monthD2 = date2.getMonth();
        let noMin =-1 , noMax = -1;

        let stringDate1 = date1.getFullYear()+"/"+(date1.getMonth()+1)+"/"+date1.getDate();
        let stringDate2 = date2.getFullYear()+"/"+(date2.getMonth()+1)+"/"+date2.getDate();
        let nbJoursCal = $(document).find('div[data-name=calendrier] td').length;
        let nbCal = $(document).find('div[data-name=calendrier]').length;
        
        for(let i=0;i<=nbCal;i++)
        {
            let cal = $(document).find('div[data-name=calendrier]').eq(i);
            let nbJoursCal = cal.find('td').length;

            // console.log(nbJoursCal);
            for(let i=0;i<nbJoursCal;i++)
            {
                let celulle = cal.find('td').eq(i);
                // console.log("attr data-date ",celulle.attr("data-date"));
                // console.log("string D1", stringDate1);
                if(celulle.attr("data-date")==stringDate1)
                {
                    noMin = celulle.attr("no");
                }
                if(celulle.attr("data-date")==stringDate2)
                {
                    noMax = celulle.attr("no");
                }
            }
        }

        return{ no1:noMin , no2:noMax }
    }        



    supprimeSelection(){
        $('div[data-name="calendrier"] td').removeClass('cal-selection');
    }
    getNumeroCalendrier(){
        return this.numCalendrier ;
    }

    addSpectacle(date){

        let cal = $('div[data-name=calendrier]>table').eq(0);
        let jours = cal.find('td');
        let nbJoursCal = jours.length;

        for(let i=0;i<arguments.length;i++)
        {

            let date = arguments[i];
            for(let jour=0;jour<nbJoursCal;jour++)
            {

                if(jours.eq(jour).attr("data-date")==date)
                {
                    jours.eq(jour).addClass("cal-spectacle");
                }
            }
            
        }
    }
    
    subscribe(obj)
    {
        this.observers.push(obj);
    }

    unsubscribe(fn) {
        this.observers = this.observers.filter(
            function (item) {
                if (item !== fn) {
                    return item;
                }
            }
        );
    }

    fire(evt) {
        let thisCal = this;
        this.observers.forEach(function (item) {
            evt.numCal = thisCal.numero;
            evt.sender = thisCal;
            item.onCalendrierEvent(evt);
        });
        
    }

}


class Container{
    constructor(calDate1,calDate2){

        this.calendriers=[]
        this.calendriers.push(calDate1);
        this.calendriers.push(calDate2);
        this.calendriers[0].subscribe(this);
        this.calendriers[1].subscribe(this);
        
        this.selectionEnCours = false;
        this.sel = [];
        this.sel.push({cal:-1,no:-1});
        this.sel.push({cal:-1,no:-1});
        this.thisContainer = this;
        this.ajouteGestionFiltre();

        // du container
        this.observers = [];
        
        $(window).mouseup(()=>{
         this.selectionEnCours = false;   
        });
        
    }
    
    domSelecteur()
    {
        let dom1 =$(`<div class="container-fluid" data-name='container'>
            <div class="row" data-name="row-calendrier">

            </div>
        </div>`);

        let domC1 = $(`<div class='col-12 col-md-6 col-lg-4' data-name='calendrier' data-divCalendrierNo='0' >`+this.calendriers[0].calendrier+`</div>`);
        let domC2 = $(`<div class='col-12 col-md-6 col-lg-4' data-name='calendrier' data-divCalendrierNo='1' >`+this.calendriers[1].calendrier+`</div>`)
        let domFiltre = $(`<div class='col-12 col-lg-4' data-name='legende-calendrier'>`+this.filtre()+`</div>`);

        let domDiv = dom1.find('div[data-name="row-calendrier"]');

        domDiv.append(domFiltre).append(domC1).append(domC2);
        
        return dom1;
    }
    
    
    affichageCalendrierNo(no){
        return this.calendriers[no]
    }
    
    
    filtre()
    {
        return "<button class='btn_Today'>Aujourd'hui</button><button class='btn_Week'>Cette semaine</button><button class='btn_NextDay'>3 prochains jours</button><button class='btn_NextWeekEnd'>Le weekend prochain</button><button class='btn_Month'>Ce mois</button><button class=btn_Periode>Quelle période ? </button>"
    }
    

    onCalendrierEvent(evt){
        // evt.sender c'est le calendier qui a envoyé l'event
        // evt.event  ="mouseUp" ou "mouseDown" ou "mouseHover"
        // evt.no     = case où a eu lieu l'event
        // evt.numCal = case où a eu lieu l'event
        
        if(evt.event == "mouseDown")
        {
            // un début de clic a eu lieu sur une case d'un des calendriers
            this.selectionEnCours = true;
            for(let i=0;i<this.calendriers.length;i++)
            {
                this.calendriers[i].supprimeSelection();
            }
            
            this.sel[0] = { cal:evt.numCal,no: evt.no};
            this.sel[1] = { cal:evt.numCal,no: evt.no};
            this.calendriers[evt.numCal].selectionne( evt.no, evt.no);
            
            this.fire({
                event : "SelectionDebut",
                // ... par exemple ajouter propriété date:date choisie
                // ...
            });

        }


        if(evt.event == "mouseUp")
        {
            // on a relaché la souris d'une des cases d'un des calendriers
            this.selectionEnCours = false;
            this.fire({
                event : "SelectionFaite",
                // ... par exemple envoyer date1, à date2
                // ...
            });
        }



        if(evt.event == "selectFin") {
            // on a relaché la souris en dehors du calendrier !
            this.selectionEnCours=false;
            this.fire({
                event : "SelectionFaite",
                // ... par exemple envoyer date1, à date2
                // ...
            });
        }


        if(evt.event == "mouseHover")
        {
            // on balade la souris sur une des cases du calendrier

            // console.log(evt.numCal);
            if(!this.selectionEnCours) {
                // pas de sélection en cours...
                this.fire({
                event : "SelectionJhesite",
                // ... par exemple envoyer date survolée
                // ...
            });
                return;
            }
            // sinon étendre la sélection
            for(let i=0;i<this.calendriers.length;i++)
            {
                this.calendriers[i].supprimeSelection();
            }
            this.sel[1] = {cal:evt.cal,no:evt.no};

            // on ne touche pas à sel[0] et sel[1] de l'objet en cours
            // mais avec une copie

            if(!isNaN(evt.cal)) // On vérifie qu'il est sur un calendrier (pour le touchmove)
            {
                let tmpSel=[
                Object.assign({},this.sel[0]),
                Object.assign({},this.sel[1]),
                ];
            
                // si 2eme date choisie inférieure à 1ere date choisie 
                if ( ((tmpSel[0].cal)*50)+(tmpSel[0].no) >  ((tmpSel[1].cal)*50)+(tmpSel[1].no) ) 
                {
                    // on permute
                    let tmpSwap=Object.assign({},tmpSel[1]);
                    tmpSel[1]=Object.assign({},tmpSel[0]);
                    tmpSel[0]=tmpSwap;
                }

                if (tmpSel[0].cal==tmpSel[1].cal) {
                    // Sélection sur un seul calendrier

                    this.calendriers[tmpSel[0].cal].selectionne(tmpSel[0].no,tmpSel[1].no);
                    

                } else {
                    
                        this.calendriers[tmpSel[0].cal].selectionne ( tmpSel[0].no , -1);
                        this.calendriers[tmpSel[1].cal].selectionne (           -1 , tmpSel[1].no);
                        // sélection à cheval sur 2 calendriers

                    
                }

                this.fire({
                    event : "SelectionExtension",
                    // ... par exemple envoyer date1, à date2
                    // ...
                });
            }

                        
        }

        
        //@TODO
        if(evt.event == "dateAChangé") {
                // un calendrier a changé sa date ( mois prec ou suivnant)
                // normalement il s'est mis à jour tout seul

                // du coup supprimer sa sélection
                //  -->cal[xx].supprimeSelection()
                let currentDate = new Date();
                let nextCalendrier =0;
                if(evt.sender.numero < (this.calendriers.length-1))
                {
                    nextCalendrier = (evt.sender.numero+1);
                }
                else{
                    nextCalendrier = (evt.sender.numero-1);
                }

                let dateChange = evt.sender.date;
                // console.log(evt.sender);
                this.calendriers[evt.sender.numero].supprimeSelection();  
                // Comparaison du mois et de l'année entre les calendriers 
                if((dateChange.getMonth()==(this.calendriers[nextCalendrier].date.getMonth())) && (dateChange.getFullYear()==(this.calendriers[nextCalendrier].date.getFullYear())) )
                {
                    // Le calendrier est identique ( même mois et même année)

                    // Si l'event envoyé est "suivant" (lors de l'appui sur l'icone), mois incrémenté
                    if(evt.mois == "suivant")
                    {
                        this.calendriers[nextCalendrier].dateRecalcule(new Date(dateChange.getFullYear(),dateChange.getMonth()+1,"1"));
                    }
                    // Si l'event envoyé est "precedent" (lors de l'appui sur l'icone), mois décrémenté
                    if(evt.mois == "precedent")
                    {
                        this.calendriers[nextCalendrier].dateRecalcule(new Date(dateChange.getFullYear(),dateChange.getMonth()-1,"1"));
                    }
                }
                
                this.calendriers[evt.sender.numero].dateRecalcule(evt.sender.date);

                // calculer nouvelleDate pour 2eme calendrier
                // actualiser le 2eme calendrier 
                //  -->cal[autre].dateRecalcule(nouvelleDate)
                this.fire({
                    event:"Changement de mois"
                    // autres infos..
                });
        }

    }


    subscribe(fn)
    {
        this.observers.push(fn);
    }


    unsubscribe(fn) {
        this.observers = this.observers.filter(
            function (item) {
                if (item !== fn) {
                    return item;
                }
            }
        );
    }

    fire(evt) {
        let thisCal = this;
        this.observers.forEach(function (item) {
            evt.sender = thisCal;
            item.onPeriodeEvent(evt);

        });
    }



    ajouteGestionFiltre() {
       //@TODO -- FAIT
       //   $(boutonMoisPrecedent.on('click')          -->onChangeMoisprecedent
       //   $(boutonMoisSuivant.on('click')          -->onChangeMoissuivant
       //   $(boutonAujourdhui).on('click') --> onAujourdhuiCaseNo
       //   $(boutonCetteSemaine.on('click')   -->onCetteSemaine
       //   $(boutonCeMois.on('click')          -->onCemois
       //   $(boutonWeekEndProchain.on('click')  -->onWeekendProchain
        $(document).on('click','.btn_Today',()=>{
            this.onAujourdhuiCaseNo()
        }).on('click', '.btn_Week', ()=>{
            this.onAcetteSemaine()
        }).on('click', '.btn_NextDay', ()=>{
            this.onJoursProchains(3);
        }).on('click', '.btn_NextWeekEnd', ()=>{
            this.onWeekEndProchain();
        }).on('click', '.btn_Month', ()=>{
            this.onCeMois();
        });

    //    $(document).on('click', '.btn_Periode',this.onAujourdhuiCaseNo);
       

       
    } 

    selectionnePeriode(ncal,n1,n2) {
        //@TODO
        // cases=this calendrier[ncal].jourAJour(dateDuJour,dateDuJour));
        //   tester cas -1
        //   calendrier[ncal].selectionne(cases.n1, cases.n2)  
        let cases = this.calendriers[ncal].casesJourAjour(n1,n2);
        this.calendriers[ncal].selectionne(cases.no1, cases.no2);
        this.fire({
            event:"Periode change"
            // autres infos..
        });
    }

    onAujourdhuiCaseNo() {
        //@TODO -- FAIT
        // dateJ = date du jour
        //pour ncal=0 à 1 {
        // selectionnePeriode(ncal,dateJ,dateJ)
        // }
        let date = new Date();
        let boolMoisAffiche = false;
        this.supprimeSelection();

        for(let i=0;(i<this.calendriers.length);i++)
        {

            if(this.calendriers[i].date.getMonth()==date.getMonth())
            {
                this.selectionnePeriode(i,date,date);
                boolMoisAffiche = true;
                return;
            }
        }
        if(!boolMoisAffiche)
        {
            let newDomJours = this.calendriers[0].generateTab(0,date);
            $('div[data-divcalendrierno=0]>table').remove();
            $('div[data-divcalendrierno=0]').append(newDomJours);
            this.selectionnePeriode(0,date,date);
        }

    }

    onAcetteSemaine() {
        //@TODO -- FAIT
        // peut être : voir si aucun calendrier ne contient la semaine, recaler calendrier de gauche sur semaine encours et droite mois d'apres
        // dateJ1 = date du jour
        // dateJ2 = date du jour+6
        // pour ncal=0 à 1 {
        //  selectionnePeriode(ncal,dateJ1,dateJ2)
        // }
        let boolMoisAffiche = false;
        let date = new Date(); // Nouvelle date actuelle
        let cpt = 0; // Compter le nombre de jour restant dans la semaine (ex : mercredi au dimanche et non mercredi au mercredi)
        for(let i=date.getDay();i<7;i++)
        {
            cpt++;
        }
        let dateSemaine = new Date(date.getFullYear(),date.getMonth(),date.getDate()+cpt) // Date fin de semaine

        this.supprimeSelection();
        for(let i=0;(i<this.calendriers.length);i++)
        {

            if(this.calendriers[i].date.getMonth()==date.getMonth())
            {
                this.selectionnePeriode(i,date,dateSemaine);
                boolMoisAffiche = true;
                return;
            }
            // this.selectionnePeriode(i,date,dateSemaine);
        }
        if(!boolMoisAffiche)
        {
            let newDomJours = this.calendriers[0].generateTab(0,date);
            $('div[data-divcalendrierno=0]>table').remove();
            $('div[data-divcalendrierno=0]').append(newDomJours);
            this.selectionnePeriode(0,date,dateSemaine);
        }

    }

    onCeMois() {
        //@TODO -- FAIT
        // dateJ1 = date début de ce mois
        // dateJ2 = date fin de ce mois
        // pour ncal=0 à 1 {
        //  selectionnePeriode(ncal,dateJ1,dateJ2)
        // }
        
        let dateJ1 = new Date(); // Date actuelle
        let month = dateJ1.getMonth();
        let boolMoisAffiche = false;
        let year = dateJ1.getFullYear()+Math.floor(dateJ1.getMonth()/12);
        let nbJoursMois = new Date(year,month+1,-1).getDate()+1;
        let dateJ2 = new Date(year,month,nbJoursMois); // Dernier jour du mois actuel

        // console.log("dateJ1",dateJ1);
        // console.log("dateJ2",dateJ2);
        this.supprimeSelection();

        for(let i=0;(i<this.calendriers.length);i++)
        {


            if(this.calendriers[i].date.getMonth()==dateJ1.getMonth())
            {
                this.selectionnePeriode(i,dateJ1,dateJ2);
                boolMoisAffiche = true;
                return;
            }
        }

        if(!boolMoisAffiche)
        {
            let newDomJours = this.calendriers[0].generateTab(0,dateJ1);
            $('div[data-divcalendrierno=0]>table').remove();
            $('div[data-divcalendrierno=0]').append(newDomJours);
            this.selectionnePeriode(0,dateJ1,dateJ2);
        }
            
    }    
    onJoursProchains(days){

        let date = new Date();
        let date2 = new Date(date.getFullYear(),date.getMonth(),(date.getDate()+days));
        let boolMoisAffiche = false;
        this.supprimeSelection();

        for(let i=0;(i<this.calendriers.length);i++)
        {
            if(this.calendriers[i].date.getMonth()==date.getMonth())
            {   
                this.selectionnePeriode(i,date,date2);
                boolMoisAffiche = true;
                return;
            }
        }
        if(!boolMoisAffiche)
        {
            let newDomJours = this.calendriers[0].generateTab(0,date);
            $('div[data-divcalendrierno=0]>table').remove();
            $('div[data-divcalendrierno=0]').append(newDomJours);
            this.selectionnePeriode(0,date,date2);
        }

    }
    onWeekEndProchain() {
        //@TODO -- FAIT
        // dateJ1=calcul date samedi prochain
        // dateJ2=date1+1 jour (dimanche)
        // pour ncal=0 à 1 {
        //  selectionnePeriode(ncal,dateJ1,dateJ2)
        // }
        let boolMoisAffiche = false;
        let date = new Date(); // Date actuelle
        let dateJ1;
        let cpt=0;

        for(let i=date.getDay();i<7;i++)
        {
            dateJ1 = new Date(date.getFullYear(),date.getMonth(),date.getDate()+cpt)
            cpt++;
        }

        let dateJ2 = new Date(dateJ1.getFullYear(),dateJ1.getMonth(),+dateJ1.getDate()+1);

        this.supprimeSelection();

        for(let i=0;(i<this.calendriers.length);i++)
        {

            if(this.calendriers[i].date.getMonth()==date.getMonth())
            {
                this.selectionnePeriode(i,dateJ1,dateJ2);
                boolMoisAffiche = true;
                return;
            }
        }

        if(!boolMoisAffiche)
        {
            let newDomJours = this.calendriers[0].generateTab(0,date);
            $('div[data-divcalendrierno=0]>table').remove();
            $('div[data-divcalendrierno=0]').append(newDomJours);
            this.selectionnePeriode(0,dateJ1,dateJ2);
        }


    }  

    onMoisProchain() {
        //@TODO
        // dateJ1=calcul date mois prochaine
        // dateJ2=fin du mois
        // this.selectionnePeriode(0,dateJ1,dateJ2);
        // this.selectionnePeriode(1,dateJ3,dateJ4); (mois +1 ??)

    }  

    onMoisPrecedent() {
        //@TODO
        // dateJ1=calcul date mois précédent
        // dateJ2=fin du mois
        // this.selectionnePeriode(0,dateJ1,dateJ2);
        // this.selectionnePeriode(1,dateJ3,dateJ4); (mois +1 ??)

    }      

    supprimeSelection(){
        for(let i = 0;i<this.calendriers.length;i++)
        {
            this.calendriers[i].supprimeSelection();
        }
    }
    





}


class EcouteurApplication  {
    
    constructor(calDate1,calDate2){

       
        const calendrier1 = new Calendrier(0,new Date());
        const calendrier2 = new Calendrier(1,new Date("2023","2","2"))

        

        const Container1 = new Container(calendrier1, calendrier2);

        // let test = new Date("2022","11","2");
        // console.log(test.getFullYear());
        let periode = document.getElementById("periode-selecteur");
        $(periode).append(Container1.domSelecteur());

        calendrier1.addSpectacle("2022/12/20","2022/12/21","2022/12/27","2023/1/2","2023/1/12","2023/2/4");

        Container1.subscribe(this);
        
    }

    onPeriodeEvent(evt) {
        $('#PERIODEECOUTEUR').html('Event reçu <br>'+evt.event);
        // selon evt.event
        // traiter evt.date1 ou date 2 , etcc...
    }


   
   
}



var appEcouteur=new EcouteurApplication();






</script>



</body>



</html>